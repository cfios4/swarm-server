---
version: "3.8"

services:

  traefik:
    image: traefik:latest
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    ports:
      - "80:80"
      - "8080:8080"
      - "65080:65080"
      - "443:443"
    networks:
      - overlaynet
    command:
      - --api.insecure=true
      - --api.dashboard=true
      - --serversTransport.insecureSkipVerify=true
      - --providers.docker=true
      - --providers.docker.watch=true
      - --providers.docker.swarmMode=true
      - --providers.docker.network=overlaynet
      - --providers.docker.exposedByDefault=false
      # - --providers.docker.defaultRule=Host(`{{ normalize .Name }}.cafio.co`)
      - --entrypoints.web.address=:80
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.websecure.address=:443
      - --entrypoints.internal.address=:65080
      - --certificatesresolvers.cf.acme.dnschallenge=true
      - --certificatesresolvers.cf.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.cf.acme.email=cfios@mf.me
      - --certificatesresolvers.cf.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.cf.acme.httpChallenge.entryPoint=web
    environment:
      - CF_DNS_API_TOKEN=
    volumes:
      - ${APPDATA_MNT}/traefik:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro

  flame:
    image: pawelmalak/flame:latest
    deploy:
      replicas: 1
      labels:
        traefik.enable: true
        traefik.http.routers.flame.rule: Host(`${DOMAIN}`)
        traefik.http.routers.flame.service: flame
        traefik.http.routers.flame.entrypoints: websecure
        traefik.http.services.flame.loadbalancer.server.port: 5005
        traefik.http.routers.flame.tls.certresolver: cf
    networks:
      - overlaynet
    environment:
      - TZ
      PASSWORD: changeme
    volumes:
      - ${APPDATA_MNT}/flame:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro

  adguard:
    image: adguard/adguardhome:latest
    deploy:
      replicas: 1
      labels:
        traefik.enable: true
        traefik.http.routers.adguard.rule: Host(`adguard.lan`)
        traefik.http.routers.adguard.service: adguard
        traefik.http.routers.adguard.entrypoints: internal
        traefik.http.services.adguard.loadbalancer.server.port: 80
        traefik.http.routers.adguard.tls.certresolver: cf
      placement:
        constraints: 
          - node.hostname == swarm0
    networks:
      - macvlan4home
    environment:
      - TZ
    volumes:
      - ${APPDATA_MNT}/adguard:/opt/adguardhome
    labels:
      - flame.type=app
      - flame.name=AdGuard Home
      - flame.icon=shield-check
      - flame.url=https://adguard.lan/
      - flame.visibility=hidden

  minio:
    image: minio/minio:latest
    deploy:
      mode: global
      labels:
        traefik.enable: true
        traefik.http.routers.minio.rule: Host(`s3.${DOMAIN}`)
        traefik.http.routers.minio.entrypoints: internal
        traefik.http.routers.minio.service: minio
        traefik.http.services.minio.loadbalancer.server.port: 9001
        traefik.http.routers.minio.tls.certresolver: cf
    networks:
      - overlaynet
    environment:
      - TZ
      - MINIO_ROOT_USER
      - MINIO_ROOT_PASSWORD
    command: 'server /data'
    volumes:
      - ${APPDATA_MNT}/minio:/data
  
  minio-client:
    image: minio/mc
    deploy:
      replicas: 1
    networks:
      - overlaynet
    depends_on:
      - minio
    entrypoint: sh -c "mc alias set minio http://minio:9000 minioadmin minioadmin && mc mb minio/{radarr,sonarr,sabnzbd,caddy,flame,plex,gitea,vaultwarden,vscode}"

networks:
  overlaynet:
    driver: overlay
  macvlan4home:
    external: true